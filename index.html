<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crossmath Arcade - Endless Mode</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        h1 {
            margin-bottom: 10px;
            font-size: 28px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        /* HUD (Heads Up Display) */
        .hud {
            display: flex;
            justify-content: space-between;
            width: 320px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .hud-item {
            background: rgba(0,0,0,0.3);
            padding: 8px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .heart { color: #e74c3c; }
        .score { color: #f1c40f; }
        .timer { color: #3498db; }

        .canvas-container {
            position: relative;
            box-shadow: 0 15px 35px rgba(0,0,0,0.5);
            border-radius: 12px;
            overflow: hidden;
            border: 4px solid #34495e;
        }

        canvas {
            background-color: #ecf0f1;
            display: block;
            cursor: pointer;
            touch-action: none; 
        }

        .controls {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 320px;
        }

        .btn-main {
            padding: 15px;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background-color: #27ae60;
            color: white;
            box-shadow: 0 4px 0 #219150;
            transition: transform 0.1s, box-shadow 0.1s;
        }

        .btn-main:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #219150;
        }

        .btn-secondary {
            background-color: #e74c3c;
            box-shadow: 0 4px 0 #c0392b;
            padding: 10px;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .btn-secondary:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #c0392b;
        }

        .numpad {
            display: none; 
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 15px;
            width: 320px;
        }
        
        @media (max-width: 600px) {
            .numpad { display: grid; }
        }

        .num-btn {
            padding: 15px;
            font-size: 20px;
            background-color: white;
            border: none;
            border-radius: 8px;
            color: #333;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .num-btn:active { background-color: #ddd; }
    </style>
</head>
<body>

    <h1>Crossmath Arcade</h1>
    
    <div class="hud">
        <div class="hud-item"><span class="heart">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span> <span id="livesText">3</span></div>
        <div class="hud-item"><span class="timer">‚è±Ô∏è</span> <span id="timerText">60</span>s</div>
        <div class="hud-item"><span class="score">‚≠ê</span> <span id="scoreText">0</span></div>
    </div>

    <div class="canvas-container">
        <canvas id="gameCanvas" width="320" height="320"></canvas>
    </div>

    <!-- Numpad untuk Mobile -->
    <div class="numpad" id="numpad">
        <button class="num-btn" onclick="inputNum('1')">1</button>
        <button class="num-btn" onclick="inputNum('2')">2</button>
        <button class="num-btn" onclick="inputNum('3')">3</button>
        <button class="num-btn" onclick="inputNum('4')">4</button>
        <button class="num-btn" onclick="inputNum('5')">5</button>
        <button class="num-btn" onclick="inputNum('6')">6</button>
        <button class="num-btn" onclick="inputNum('7')">7</button>
        <button class="num-btn" onclick="inputNum('8')">8</button>
        <button class="num-btn" onclick="inputNum('9')">9</button>
        <button class="num-btn" onclick="inputNum('0')">0</button>
        <button class="num-btn" style="grid-column: span 2; background-color: #ffcccc;" onclick="inputBackspace()">‚å´ Hapus</button>
    </div>

    <div class="controls">
        <button class="btn-main" onclick="checkAnswers()">‚úÖ CEK JAWABAN</button>
        <button class="btn-secondary" onclick="resetGame()">üîÑ Reset Game</button>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const livesEl = document.getElementById('livesText');
        const timerEl = document.getElementById('timerText');
        const scoreEl = document.getElementById('scoreText');

        // Config
        const ROWS = 5;
        const COLS = 5;
        const CELL_SIZE = canvas.width / COLS; 

        // Game State
        let lives = 3;
        let score = 0;
        let level = 1;
        let timeLeft = 60;
        let timerInterval = null;
        let isGameActive = true;
        let selectedCell = null;
        
        // Grid Data
        let grid = [];
        let currentLevelConfig = null;

        // Level Database
        const LEVELS = [
            { // L1: Basic Ops
                grid: [
                    [{t:'fixed', v:'4'}, {t:'op', v:'√ó'}, {t:'input', ans:'6', val:'', state:'neutral'}, {t:'op', v:'='}, {t:'fixed', v:'24'}],
                    [{t:'op', v:'√ó'}, {t:'empty'}, {t:'op', v:'√∑'}, {t:'empty'}, {t:'op', v:'√∑'}],
                    [{t:'input', ans:'3', val:'', state:'neutral'}, {t:'op', v:'√ó'}, {t:'fixed', v:'2'}, {t:'op', v:'='}, {t:'input', ans:'6', val:'', state:'neutral'}],
                    [{t:'op', v:'='}, {t:'empty'}, {t:'op', v:'='}, {t:'empty'}, {t:'op', v:'='}],
                    [{t:'input', ans:'12', val:'', state:'neutral'}, {t:'op', v:'√∑'}, {t:'input', ans:'3', val:'', state:'neutral'}, {t:'op', v:'='}, {t:'fixed', v:'4'}]
                ]
            },
            { // L2: Addition
                grid: [
                    [{t:'input', ans:'1', val:'', state:'neutral'}, {t:'op', v:'+'}, {t:'fixed', v:'2'}, {t:'op', v:'='}, {t:'input', ans:'3', val:'', state:'neutral'}],
                    [{t:'op', v:'+'}, {t:'empty'}, {t:'op', v:'+'}, {t:'empty'}, {t:'op', v:'+'}],
                    [{t:'fixed', v:'4'}, {t:'op', v:'+'}, {t:'input', ans:'5', val:'', state:'neutral'}, {t:'op', v:'='}, {t:'fixed', v:'9'}],
                    [{t:'op', v:'='}, {t:'empty'}, {t:'op', v:'='}, {t:'empty'}, {t:'op', v:'='}],
                    [{t:'input', ans:'5', val:'', state:'neutral'}, {t:'op', v:'+'}, {t:'fixed', v:'7'}, {t:'op', v:'='}, {t:'input', ans:'12', val:'', state:'neutral'}]
                ]
            },
            { // L3: Mixed Hard
                grid: [
                    [{t:'input', ans:'6', val:'', state:'neutral'}, {t:'op', v:'√∑'}, {t:'input', ans:'2', val:'', state:'neutral'}, {t:'op', v:'='}, {t:'fixed', v:'3'}],
                    [{t:'op', v:'+'}, {t:'empty'}, {t:'op', v:'√ó'}, {t:'empty'}, {t:'op', v:'√ó'}],
                    [{t:'fixed', v:'1'}, {t:'op', v:'+'}, {t:'input', ans:'4', val:'', state:'neutral'}, {t:'op', v:'='}, {t:'input', ans:'5', val:'', state:'neutral'}],
                    [{t:'op', v:'='}, {t:'empty'}, {t:'op', v:'='}, {t:'empty'}, {t:'op', v:'='}],
                    [{t:'input', ans:'7', val:'', state:'neutral'}, {t:'op', v:'+'}, {t:'fixed', v:'8'}, {t:'op', v:'='}, {t:'fixed', v:'15'}]
                ]
            }
        ];

        // --- CORE GAMEPLAY ---

        function initGame() {
            lives = 3;
            score = 0;
            level = 1;
            loadLevel(0);
            updateHUD();
        }

        function loadLevel(levelIdx) {
            // Loop level jika habis (Endless Mode)
            const actualIdx = levelIdx % LEVELS.length;
            
            // Deep copy grid
            grid = JSON.parse(JSON.stringify(LEVELS[actualIdx].grid));
            
            // Reset state level
            selectedCell = null;
            isGameActive = true;
            
            // Set Timer (Semakin tinggi level, semakin sedikit waktu minus 5 detik per loop)
            const loopCount = Math.floor(levelIdx / LEVELS.length);
            timeLeft = Math.max(20, 60 - (loopCount * 10)); // Min 20 detik
            
            startTimer();
            draw();
            
            // Efek transisi level
            showToast(`LEVEL ${levelIdx + 1}`);
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if (!isGameActive) return;
                timeLeft--;
                updateHUD();
                
                if (timeLeft <= 0) {
                    handleGameOver("WAKTU HABIS!");
                }
            }, 1000);
        }

        function checkAnswers() {
            if (!isGameActive) return;

            let allCorrect = true;
            let hasError = false;
            let filledCount = 0;
            let totalInputs = 0;

            // 1. Validasi
            for (let r = 0; r < ROWS; r++) {
                for (let c = 0; c < COLS; c++) {
                    const cell = grid[r][c];
                    if (cell.t === 'input') {
                        totalInputs++;
                        if (cell.val !== '') filledCount++;

                        if (cell.val === cell.ans) {
                            cell.state = 'correct'; // Hijau
                        } else {
                            if (cell.val !== '') {
                                cell.state = 'wrong'; // Merah
                                hasError = true;
                                allCorrect = false;
                            } else {
                                // Kosong dianggap belum benar
                                allCorrect = false; 
                            }
                        }
                    }
                }
            }

            // 2. Feedback Logic
            draw();

            if (hasError) {
                lives--;
                updateHUD();
                showToast("JAWABAN SALAH! -1 ‚ù§Ô∏è");
                if (lives <= 0) {
                    handleGameOver("GAME OVER");
                }
            } else if (filledCount < totalInputs) {
                showToast("ISI SEMUA KOTAK!");
            } else if (allCorrect) {
                // WIN LEVEL
                score += 50 + (timeLeft * 2); // Bonus skor
                level++;
                updateHUD();
                showToast("LEVEL SELESAI! +50 Pts");
                
                setTimeout(() => {
                    loadLevel(level - 1);
                }, 1500);
            } else {
                // Kasus lain (misal kosong semua)
            }
        }

        function handleGameOver(reason) {
            isGameActive = false;
            clearInterval(timerInterval);
            
            // Draw Overlay
            ctx.fillStyle = "rgba(44, 62, 80, 0.9)";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = "#e74c3c";
            ctx.font = "bold 32px Arial";
            ctx.textAlign = "center";
            ctx.fillText(reason, canvas.width/2, canvas.height/2 - 30);
            
            ctx.fillStyle = "#fff";
            ctx.font = "20px Arial";
            ctx.fillText(`Skor Akhir: ${score}`, canvas.width/2, canvas.height/2 + 10);
            
            ctx.font = "14px Arial";
            ctx.fillText("Tekan Reset untuk main lagi", canvas.width/2, canvas.height/2 + 40);
        }

        function resetGame() {
            initGame();
        }

        function updateHUD() {
            livesEl.innerText = lives;
            scoreEl.innerText = score;
            timerEl.innerText = timeLeft;
            
            // Update Heart Visuals (Optional text update is handled above)
            const hearts = "‚ù§Ô∏è".repeat(Math.max(0, lives));
            document.querySelector('.heart').innerText = hearts;

            if (timeLeft <= 10) timerEl.style.color = '#e74c3c';
            else timerEl.style.color = '#3498db';
        }

        function showToast(msg) {
            // Simple canvas toast
            ctx.save();
            ctx.font = "bold 20px Arial";
            ctx.textAlign = "center";
            ctx.fillStyle = "rgba(0,0,0,0.7)";
            ctx.fillRect(20, canvas.height/2 - 20, canvas.width - 40, 40);
            ctx.fillStyle = "#fff";
            ctx.fillText(msg, canvas.width/2, canvas.height/2 + 7);
            ctx.restore();
            
            // Redraw after delay to clear toast
            setTimeout(draw, 1000);
        }

        // --- DRAWING ---

        function draw() {
            if (!isGameActive && lives <= 0) return; // Jangan gambar ulang jika game over overlay aktif

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            for (let r = 0; r < ROWS; r++) {
                for (let c = 0; c < COLS; c++) {
                    const cell = grid[r][c];
                    const x = c * CELL_SIZE;
                    const y = r * CELL_SIZE;

                    if (cell.t === 'empty') continue;

                    // Base Style
                    ctx.strokeStyle = "#7f8c8d";
                    ctx.lineWidth = 2;
                    let bgColor = "#ecf0f1";
                    let textColor = "#2c3e50";

                    if (cell.t === 'input') {
                        bgColor = "#fff";
                        
                        // State Colors
                        if (cell.state === 'correct') {
                            bgColor = "#2ecc71"; // Hijau
                            textColor = "#fff";
                        } else if (cell.state === 'wrong') {
                            bgColor = "#e74c3c"; // Merah
                            textColor = "#fff";
                        } else if (selectedCell && selectedCell.r === r && selectedCell.c === c) {
                            bgColor = "#3498db"; // Biru (Fokus)
                            textColor = "#fff";
                        }
                    } else {
                        // Fixed / Operator
                        bgColor = "#bdc3c7";
                    }

                    // Draw Box
                    ctx.fillStyle = bgColor;
                    ctx.fillRect(x + 3, y + 3, CELL_SIZE - 6, CELL_SIZE - 6);
                    
                    // Style border untuk cell aktif
                    if (selectedCell && selectedCell.r === r && selectedCell.c === c) {
                        ctx.strokeStyle = "#2980b9";
                        ctx.lineWidth = 4;
                    }
                    
                    ctx.strokeRect(x + 3, y + 3, CELL_SIZE - 6, CELL_SIZE - 6);

                    // Draw Text
                    ctx.fillStyle = textColor;
                    ctx.font = "bold " + (CELL_SIZE * 0.5) + "px Arial";
                    ctx.textAlign = "center";
                    ctx.textBaseline = "middle";

                    let text = cell.v || cell.val;
                    ctx.fillText(text, x + CELL_SIZE/2, y + CELL_SIZE/2 + 2);
                }
            }
        }

        // --- INPUTS ---

        window.inputNum = function(num) {
            if (!isGameActive || !selectedCell) return;
            const cell = grid[selectedCell.r][selectedCell.c];
            
            // Reset state jika user mengetik ulang di kotak yang salah
            if (cell.state === 'wrong') cell.state = 'neutral';

            if (cell.val.length < 2) {
                cell.val += num;
                draw();
            }
        };

        window.inputBackspace = function() {
            if (!isGameActive || !selectedCell) return;
            const cell = grid[selectedCell.r][selectedCell.c];
            cell.val = cell.val.slice(0, -1);
            cell.state = 'neutral';
            draw();
        };

        function handlePointer(e) {
            e.preventDefault();
            if (!isGameActive) return;

            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            const c = Math.floor((clientX - rect.left) / CELL_SIZE);
            const r = Math.floor((clientY - rect.top) / CELL_SIZE);

            if (r >= 0 && r < ROWS && c >= 0 && c < COLS) {
                const cell = grid[r][c];
                if (cell.t === 'input') {
                    selectedCell = { r, c };
                    // Clear 'wrong' state on select to encourage trying again
                    if(cell.state === 'wrong') cell.val = ''; 
                    cell.state = 'neutral';
                } else {
                    selectedCell = null;
                }
                draw();
            }
        }

        canvas.addEventListener('mousedown', handlePointer);
        canvas.addEventListener('touchstart', handlePointer, {passive: false});

        window.addEventListener('keydown', (e) => {
            if (!isGameActive) return;
            if (e.key === 'Enter') checkAnswers();
            if (!selectedCell) return;

            if (e.key >= '0' && e.key <= '9') inputNum(e.key);
            if (e.key === 'Backspace') inputBackspace();
        });

        // Start Game
        initGame();

    </script>
</body>
</html>
